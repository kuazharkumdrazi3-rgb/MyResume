<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plant Visit Planner ‚Äì Revamp (No Google iFrame)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />

  <!-- Leaflet (NO Google iframe, fixes X-Frame-Options blocking) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#070A10;
      --panel:#0D1220;
      --panel2:#111A2E;
      --border:#22304F;
      --muted:#A7B2D6;
      --text:#F3F6FF;
      --accent:#7C3AED;
      --accent2:#22C55E;
      --warn:#F59E0B;
      --danger:#EF4444;
      --chip:#0B1020;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(124,58,237,.20), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(34,197,94,.16), transparent 55%),
        radial-gradient(900px 700px at 40% 100%, rgba(59,130,246,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow:hidden; /* we manage scroll inside panels */
    }

    .app{
      height:100vh;
      display:grid;
      grid-template-rows:auto 1fr auto;
      max-width: 1700px;
      margin: 0 auto;
      padding: 14px;
      gap: 12px;
      min-height:0;
    }

    /* Top bar */
    .topbar{
      background: linear-gradient(180deg, rgba(17,26,46,.95), rgba(13,18,32,.92));
      border:1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;min-width:220px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: radial-gradient(circle at 30% 25%, rgba(124,58,237,.7), rgba(34,197,94,.25), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.08);
    }
    .brand h1{margin:0;font-size: 15px;letter-spacing:.3px}
    .brand .sub{color:var(--muted);font-size: 12px;margin-top:2px}

    .actions{
      display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;
    }
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      display:inline-flex;align-items:center;gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.20); background: rgba(255,255,255,.09);}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none;}
    .btn-primary{
      background: rgba(124,58,237,.20);
      border-color: rgba(124,58,237,.45);
    }
    .btn-good{
      background: rgba(34,197,94,.16);
      border-color: rgba(34,197,94,.40);
    }
    .btn-danger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.35);
    }

    .pill{
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      padding: 6px 10px;
      border-radius: 999px;
      display:inline-flex;align-items:center;gap:6px;
      white-space:nowrap;
    }
    .pill b{color:var(--text)}
    .sep{width:1px;height:32px;background:rgba(255,255,255,.08); margin:0 2px;}

    /* Main layout */
    .main{
      min-height:0;
      display:grid;
      grid-template-columns: 460px 1fr;
      gap: 12px;
    }

    .panel{
      min-height:0;
      background: linear-gradient(180deg, rgba(17,26,46,.92), rgba(13,18,32,.92));
      border:1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    /* Left: list */
    .list-header{
      padding: 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      gap: 10px;
      flex-shrink:0;
    }
    .search{
      display:flex; gap:8px; align-items:center;
    }
    .search input{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-weight: 650;
    }

    .chips{
      display:flex;flex-wrap:wrap;gap:8px;
    }
    .chip{
      cursor:pointer;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      display:inline-flex; align-items:center; gap:6px;
      user-select:none;
      transition: background .12s ease, border-color .12s ease;
    }
    .chip.active{
      background: rgba(124,58,237,.18);
      border-color: rgba(124,58,237,.45);
      color: var(--text);
    }

    .list{
      /* THIS is the scroll container */
      flex:1;
      min-height:0;
      overflow:auto;
      padding: 10px;
    }

    .card{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      margin-bottom: 8px;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      cursor:pointer;
    }
    .card:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }
    .card.selected{
      border-color: rgba(124,58,237,.55);
      background: rgba(124,58,237,.12);
    }
    .card.visited{
      opacity: .58;
      background: rgba(0,0,0,.18);
    }
    .n{
      width:32px;height:32px;border-radius: 12px;
      display:flex;align-items:center;justify-content:center;
      font-weight: 900; font-size: 12px;
      color: var(--text);
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      flex-shrink:0;
    }
    .meta{min-width:0; flex:1}
    .meta .name{
      font-weight: 900;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .meta .addr{
      margin-top: 2px;
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .badge{
      font-size: 11px;
      font-weight: 900;
      padding: 5px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      flex-shrink:0;
      max-width: 120px;
      text-overflow: ellipsis;
      overflow:hidden;
      white-space:nowrap;
    }
    .badge.good{color: #86efac; border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12);}
    .badge.wait{color: #c7d2fe; border-color: rgba(99,102,241,.35); background: rgba(99,102,241,.10);}
    .badge.warn{color: #fde68a; border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10);}
    .badge.err{color: #fecaca; border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10);}

    .tick{
      width: 28px; height: 28px; border-radius: 10px;
      border:1px solid rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      flex-shrink:0;
      font-weight: 900;
      color: var(--muted);
      background: rgba(0,0,0,.20);
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, border-color .12s ease;
    }
    .tick.on{
      color:#04130b;
      background: rgba(34,197,94,.95);
      border-color: rgba(34,197,94,.95);
    }

    /* Right: map + details */
    .map-wrap{
      position:relative;
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .map-top{
      flex-shrink:0;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
    }
    .titleblock{min-width:0}
    .titleblock .t1{
      font-weight: 950;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .titleblock .t2{
      margin-top:2px;
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .map-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    #map{
      flex:1;
      min-height:0;
      background: #0a0d14;
    }

    /* Footer status */
    .footer{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
    }
    .footer .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .footer .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .dot{
      width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.20);
      border:1px solid rgba(255,255,255,.10);
    }
    .dot.good{background: rgba(34,197,94,.9); border-color: rgba(34,197,94,.9);}
    .dot.warn{background: rgba(245,158,11,.9); border-color: rgba(245,158,11,.9);}
    .dot.err{background: rgba(239,68,68,.9); border-color: rgba(239,68,68,.9);}

    /* Mobile */
    @media (max-width: 980px){
      body{overflow:auto}
      .app{height:auto; overflow:visible}
      .main{grid-template-columns: 1fr; }
      .panel{height: 52vh;}
      .panel.mapPanel{height: 48vh;}
    }
  </style>
</head>

<body>
<div class="app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Plant Visit Planner</h1>
        <div class="sub">Revamp UI ‚Ä¢ Leaflet Map ‚Ä¢ OSRM driving distance</div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="pill" id="pillGPS">üìç GPS: <b>Not set</b></div>
    <div class="pill" id="pillProgress">‚úÖ Visited: <b>0</b>/<span id="totalCount">0</span></div>

    <div class="sep"></div>

    <div class="actions">
      <button class="btn btn-primary" id="btnGPS">Update GPS</button>
      <button class="btn btn-good" id="btnSortDrive">Sort Unvisited by Driving Distance</button>
      <button class="btn" id="btnShowAll">Show All</button>
      <button class="btn" id="btnShowUnvisited">Unvisited Only</button>
      <button class="btn btn-danger" id="btnReset">Reset Visited</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- LEFT LIST -->
    <div class="panel">
      <div class="list-header">
        <div class="search">
          <input id="q" placeholder="Search company / address‚Ä¶" />
        </div>
        <div class="chips">
          <div class="chip active" id="chipAll">All</div>
          <div class="chip" id="chipUnvisited">Unvisited</div>
          <div class="chip" id="chipVisited">Visited</div>
          <div class="chip" id="chipHasDistance">Has distance</div>
          <div class="chip" id="chipNoDistance">No distance</div>
        </div>
      </div>
      <div class="list" id="list"></div>
    </div>

    <!-- RIGHT MAP -->
    <div class="panel mapPanel">
      <div class="map-wrap">
        <div class="map-top">
          <div class="titleblock">
            <div class="t1" id="selTitle">Select a plant</div>
            <div class="t2" id="selSub">Map + route will appear here (no Google iframe)</div>
          </div>
          <div class="map-actions">
            <button class="btn" id="btnRoute">Draw Route</button>
            <button class="btn" id="btnOpenOSM">Open OSM</button>
            <button class="btn" id="btnOpenGoogle">Open Google</button>
            <button class="btn" id="btnWaze">Waze</button>
          </div>
        </div>
        <div id="map"></div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <div class="left">
      <span class="dot" id="netDot"></span>
      <span id="status">Ready.</span>
    </div>
    <div class="right">
      <span class="pill">Distance source: <b>OSRM (driving)</b></span>
      <span class="pill">Map source: <b>OpenStreetMap tiles</b></span>
    </div>
  </div>
</div>

<script>
  /**************************************************************
   *  DATA (keep your array; add more companies yourself later)
   **************************************************************/
  const plants = [
    { id:"aureumaex", name:"Aureumaex Precision Plastics (M) Sdn Bhd", area:"Lot 136, Jalan Permata 1, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat:2.8258, lng:101.8105 },
    { id:"ichikoh", name:"Ichikoh (M) Sdn. Bhd.", area:"Lot 110, Jalan Permata 1/4, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat:2.8214, lng:101.8083 },
    { id:"johnson_matthey", name:"Johnson Matthey Sdn. Bhd.", area:"Lot 12, Jalan 2, Kawasan Perindustrian Nilai 3, 71800 Nilai, Negeri Sembilan", lat:2.8125, lng:101.7925 },
    { id:"mapei_nilai", name:"Mapei Malaysia Nilai Plant", area:"D3A, Lot 28, Jalan Industri 3/4, Kawasan Perindustrian Nilai 3, 71800 Nilai, Negeri Sembilan", lat:2.8520, lng:101.7980 },
    { id:"asachem_sa", name:"Asachem (M) Sdn. Bhd.", area:"Lot 10, Jalan Lada Sulah 16/11, Seksyen 16, 40200 Shah Alam, Selangor", lat:3.0300, lng:101.4800 },
    { id:"edenor_oleo", name:"Edenor Oleochemicals (M) Sdn Bhd", area:"Lot 1, Jalan Lebuh Raya, Pelabuhan Klang, 42000 Port Klang, Selangor", lat:2.9150, lng:101.4550 },
    { id:"ysp_industries", name:"Y.S.P Industries (M) Sdn Bhd", area:"Lot 3, 5 & 7, Jalan P/7, Section 13, Kawasan Perindustrian Bangi, 43650 Bandar Baru Bangi, Selangor", lat:2.9450, lng:101.7850 },
    { id:"duopharma", name:"Duopharma Manufacturing (Bangi) Sdn Bhd", area:"Lot 2, 4, 6, 8 & 10, Jalan P/7, Section 13, Kawasan Perindustrian Bangi, 43650 Bandar Baru Bangi, Selangor", lat:2.9400, lng:101.7800 },
    { id:"chembond", name:"Chembond Chemicals(Malaysia) Sdn Bhd", area:"No. 15, Jalan Utarid U5/15, Seksyen U5, 40150 Shah Alam, Selangor", lat:3.0500, lng:101.4800 },
    { id:"air_liquide", name:"Air Liquide Malaysia Sdn. Bhd. (Melaka Plant)", area:"Lot 3, Jalan PK 1, Kawasan Perindustrian Krubong, 75250 Melaka", lat:2.2500, lng:102.1500 }
  ];

  /**************************************************************
   *  STORAGE + STATE
   **************************************************************/
  const VISITED_KEY = "pv_revamp_visited_v1";
  const GPS_KEY     = "pv_revamp_gps_v1";

  let visited = {};
  try { visited = JSON.parse(localStorage.getItem(VISITED_KEY) || "{}"); } catch { visited = {}; }

  let user = null;
  try {
    const tmp = JSON.parse(localStorage.getItem(GPS_KEY) || "null");
    if (tmp && typeof tmp.lat === "number" && typeof tmp.lng === "number") user = tmp;
  } catch {}

  let selectedId = null;
  let routeLine = null;
  let userMarker = null;
  let plantMarker = null;

  let filterMode = "all"; // all | unvisited | visited
  let filterDist = "any"; // any | has | no
  let unvisitedOnlyQuick = false;

  let isBusy = false;

  /**************************************************************
   *  UI ELEMENTS
   **************************************************************/
  const elList = document.getElementById("list");
  const elQ = document.getElementById("q");
  const elStatus = document.getElementById("status");
  const elGPSPill = document.getElementById("pillGPS");
  const elProgress = document.getElementById("pillProgress");
  const elTotal = document.getElementById("totalCount");
  const elSelTitle = document.getElementById("selTitle");
  const elSelSub = document.getElementById("selSub");
  const netDot = document.getElementById("netDot");

  const btnGPS = document.getElementById("btnGPS");
  const btnSortDrive = document.getElementById("btnSortDrive");
  const btnShowAll = document.getElementById("btnShowAll");
  const btnShowUnvisited = document.getElementById("btnShowUnvisited");
  const btnReset = document.getElementById("btnReset");

  const btnRoute = document.getElementById("btnRoute");
  const btnOpenOSM = document.getElementById("btnOpenOSM");
  const btnOpenGoogle = document.getElementById("btnOpenGoogle");
  const btnWaze = document.getElementById("btnWaze");

  /**************************************************************
   *  MAP INIT (Leaflet)
   **************************************************************/
  const map = L.map("map", { zoomControl: true });
  const defaultCenter = [2.95, 101.75]; // MY-ish
  map.setView(defaultCenter, 9);

  // OSM tiles (no iframe, no Google X-Frame errors)
  const tile = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  });
  tile.addTo(map);

  function setStatus(msg, level="ok"){
    elStatus.textContent = msg;
    netDot.className = "dot";
    if (level==="ok") netDot.classList.add("good");
    if (level==="warn") netDot.classList.add("warn");
    if (level==="err") netDot.classList.add("err");
  }

  function saveVisited(){
    localStorage.setItem(VISITED_KEY, JSON.stringify(visited));
    updateProgress();
  }

  function updateProgress(){
    elTotal.textContent = plants.length;
    const done = Object.values(visited).filter(Boolean).length;
    elProgress.innerHTML = `‚úÖ Visited: <b>${done}</b>/${plants.length}`;
  }

  function updateGpsPill(){
    if (!user){
      elGPSPill.innerHTML = `üìç GPS: <b>Not set</b>`;
      return;
    }
    elGPSPill.innerHTML = `üìç GPS: <b>${user.lat.toFixed(5)}, ${user.lng.toFixed(5)}</b>`;
  }

  function clearDistances(){
    plants.forEach(p => { delete p._roadMeters; delete p._roadKm; delete p._roadErr; delete p._pending; });
  }

  function km1(m){ return (m/1000).toFixed(1); }

  /**************************************************************
   *  FILTER + SORT
   **************************************************************/
  function filteredPlants(){
    const q = elQ.value.trim().toLowerCase();
    return plants.filter(p => {
      if (q){
        const hay = (p.name + " " + p.area).toLowerCase();
        if (!hay.includes(q)) return false;
      }

      const isV = !!visited[p.id];

      if (filterMode === "visited" && !isV) return false;
      if (filterMode === "unvisited" && isV) return false;

      const hasDist = typeof p._roadMeters === "number";
      if (filterDist === "has" && !hasDist) return false;
      if (filterDist === "no" && hasDist) return false;

      if (unvisitedOnlyQuick && isV) return false;

      return true;
    });
  }

  function sortForDisplay(list){
    // Unvisited first, then by driving distance (known), then unknown, then name.
    return list.slice().sort((a,b)=>{
      const av = !!visited[a.id];
      const bv = !!visited[b.id];
      if (av !== bv) return av - bv;

      const da = (typeof a._roadMeters === "number") ? a._roadMeters : Number.POSITIVE_INFINITY;
      const db = (typeof b._roadMeters === "number") ? b._roadMeters : Number.POSITIVE_INFINITY;
      if (da !== db) return da - db;

      return a.name.localeCompare(b.name);
    });
  }

  /**************************************************************
   *  OSRM (driving distance + route)
   **************************************************************/
  async function osrmTable(origin, dests){
    // coords = lon,lat;lon,lat;...
    const coords = [
      `${origin.lng},${origin.lat}`,
      ...dests.map(d => `${d.lng},${d.lat}`)
    ].join(";");

    const destinations = dests.map((_,i)=> i+1).join(";");
    const url = `https://router.project-osrm.org/table/v1/driving/${coords}?sources=0&destinations=${destinations}&annotations=distance`;

    const res = await fetch(url);
    if (!res.ok) throw new Error("OSRM table failed: " + res.status);
    const data = await res.json();
    const row = data?.distances?.[0];
    if (!Array.isArray(row)) throw new Error("OSRM table invalid");
    return row; // meters or null
  }

  async function osrmRoute(origin, dest){
    const url = `https://router.project-osrm.org/route/v1/driving/${origin.lng},${origin.lat};${dest.lng},${dest.lat}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("OSRM route failed: " + res.status);
    const data = await res.json();
    const r = data?.routes?.[0];
    if (!r || !r.geometry) throw new Error("OSRM route invalid");
    return r; // contains geometry, distance, duration
  }

  async function sortUnvisitedByDrivingDistance(){
    if (!user){
      alert("Update GPS first.");
      return;
    }
    if (isBusy) return;

    isBusy = true;
    btnSortDrive.disabled = true;
    btnGPS.disabled = true;

    setStatus("Calculating driving distances for unvisited‚Ä¶", "warn");

    const targets = plants.filter(p => !visited[p.id]);
    if (!targets.length){
      setStatus("All plants are visited. Nothing to sort.", "ok");
      isBusy = false;
      btnSortDrive.disabled = false;
      btnGPS.disabled = false;
      return;
    }

    // batch to avoid OSRM demo limits
    const BATCH = 70;
    for (let i=0; i<targets.length; i+=BATCH){
      const chunk = targets.slice(i, i+BATCH);
      chunk.forEach(p => p._pending = true);
      render();

      try{
        const metersList = await osrmTable(user, chunk);
        metersList.forEach((m, idx)=>{
          const p = chunk[idx];
          delete p._pending;
          if (typeof m === "number" && isFinite(m)){
            p._roadMeters = m;
            p._roadKm = km1(m);
            delete p._roadErr;
          } else {
            p._roadErr = true;
            delete p._roadMeters;
            delete p._roadKm;
          }
        });
      } catch(e){
        console.error(e);
        chunk.forEach(p=>{
          delete p._pending;
          p._roadErr = true;
          delete p._roadMeters;
          delete p._roadKm;
        });
        setStatus("OSRM busy/blocked. Some distances may show error.", "warn");
        // polite pause
        await new Promise(r=>setTimeout(r, 900));
      }

      render();
      await new Promise(r=>setTimeout(r, 250));
    }

    setStatus("Done. Unvisited sorted by driving distance.", "ok");
    isBusy = false;
    btnSortDrive.disabled = false;
    btnGPS.disabled = false;
  }

  /**************************************************************
   *  RENDER
   **************************************************************/
  function render(){
    updateProgress();
    updateGpsPill();

    const list = sortForDisplay(filteredPlants());

    elList.innerHTML = "";
    list.forEach((p, idx)=>{
      const isV = !!visited[p.id];
      const sel = p.id === selectedId;

      const card = document.createElement("div");
      card.className = "card" + (isV ? " visited" : "") + (sel ? " selected" : "");

      const n = document.createElement("div");
      n.className = "n";
      n.textContent = String(idx + 1);

      const meta = document.createElement("div");
      meta.className = "meta";

      const nm = document.createElement("div");
      nm.className = "name";
      nm.textContent = p.name;

      const addr = document.createElement("div");
      addr.className = "addr";
      addr.textContent = p.area;

      meta.appendChild(nm);
      meta.appendChild(addr);

      const badge = document.createElement("div");
      badge.className = "badge";

      if (p._pending){
        badge.classList.add("wait");
        badge.textContent = "‚è≥ calc‚Ä¶";
      } else if (typeof p._roadMeters === "number"){
        badge.classList.add("good");
        badge.textContent = `üöó ${p._roadKm} km`;
      } else if (p._roadErr){
        badge.classList.add("err");
        badge.textContent = "‚ö† route?";
      } else if (user){
        badge.classList.add("warn");
        badge.textContent = "‚Äî no dist";
      } else {
        badge.textContent = "GPS first";
      }

      const tick = document.createElement("div");
      tick.className = "tick" + (isV ? " on" : "");
      tick.textContent = isV ? "‚úì" : "";
      tick.title = "Toggle visited";
      tick.onclick = (e)=>{
        e.stopPropagation();
        visited[p.id] = !visited[p.id];
        saveVisited();
        // keep sorted feel
        render();
      };

      card.appendChild(n);
      card.appendChild(meta);
      card.appendChild(badge);
      card.appendChild(tick);

      card.onclick = ()=> selectPlant(p.id);

      elList.appendChild(card);
    });

    // enable/disable map action buttons
    const hasSel = !!selectedId;
    btnRoute.disabled = !hasSel || !user;
    btnOpenOSM.disabled = !hasSel;
    btnOpenGoogle.disabled = !hasSel;
    btnWaze.disabled = !hasSel;
  }

  /**************************************************************
   *  SELECT PLANT + MAP UPDATE
   **************************************************************/
  function selectPlant(id){
    selectedId = id;
    const p = plants.find(x=>x.id===id);
    if (!p) return;

    elSelTitle.textContent = p.name;
    elSelSub.textContent = p.area;

    // markers
    if (plantMarker) plantMarker.remove();
    plantMarker = L.marker([p.lat, p.lng]).addTo(map).bindPopup(p.name);

    if (user){
      if (userMarker) userMarker.remove();
      userMarker = L.circleMarker([user.lat, user.lng], {
        radius: 8,
        color: "#22C55E",
        weight: 3,
        fillColor: "#22C55E",
        fillOpacity: 0.35
      }).addTo(map).bindPopup("You are here");
      map.fitBounds(L.latLngBounds([[user.lat,user.lng],[p.lat,p.lng]]).pad(0.35));
    } else {
      map.setView([p.lat, p.lng], 13);
    }

    // clear any old route line when selecting new plant
    if (routeLine) { routeLine.remove(); routeLine = null; }

    render();
  }

  async function drawRoute(){
    if (!user){
      alert("Update GPS first.");
      return;
    }
    if (!selectedId){
      alert("Select a plant first.");
      return;
    }
    if (isBusy) return;

    const p = plants.find(x=>x.id===selectedId);
    if (!p) return;

    isBusy = true;
    btnRoute.disabled = true;
    setStatus("Fetching route polyline‚Ä¶", "warn");

    try{
      const r = await osrmRoute(user, p);

      if (routeLine) routeLine.remove();
      routeLine = L.geoJSON(r.geometry, {
        style: { weight: 5, opacity: 0.85 } // default Leaflet color
      }).addTo(map);

      const km = km1(r.distance);
      const min = Math.round(r.duration / 60);
      setStatus(`Route drawn: ${km} km ‚Ä¢ ~${min} min`, "ok");
      map.fitBounds(routeLine.getBounds().pad(0.25));

    } catch(e){
      console.error(e);
      setStatus("Route failed (OSRM blocked or rate-limited). Try again.", "err");
      alert("Could not fetch route. Your network may block OSRM or is rate-limited.");
    }

    isBusy = false;
    btnRoute.disabled = !selectedId || !user;
  }

  function openOSM(){
    const p = plants.find(x=>x.id===selectedId);
    if (!p) return;
    const url = `https://www.openstreetmap.org/?mlat=${p.lat}&mlon=${p.lng}#map=16/${p.lat}/${p.lng}`;
    window.open(url, "_blank");
  }

  function openGoogle(){
    const p = plants.find(x=>x.id===selectedId);
    if (!p) return;

    if (user){
      window.open(
        `https://www.google.com/maps/dir/?api=1&origin=${user.lat},${user.lng}&destination=${p.lat},${p.lng}&travelmode=driving`,
        "_blank"
      );
    } else {
      window.open(
        `https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lng}`,
        "_blank"
      );
    }
  }

  function openWaze(){
    const p = plants.find(x=>x.id===selectedId);
    if (!p) return;
    window.location.href = `https://waze.com/ul?ll=${p.lat},${p.lng}&navigate=yes`;
  }

  /**************************************************************
   *  GPS
   **************************************************************/
  function updateGPS(){
    if (!navigator.geolocation){
      alert("Geolocation not supported in this browser.");
      return;
    }
    if (isBusy) return;

    setStatus("Getting GPS‚Ä¶", "warn");
    btnGPS.disabled = true;

    navigator.geolocation.getCurrentPosition(
      pos=>{
        user = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        localStorage.setItem(GPS_KEY, JSON.stringify(user));

        // origin changed => clear distances + route
        clearDistances();
        if (routeLine) { routeLine.remove(); routeLine = null; }

        // show marker
        if (userMarker) userMarker.remove();
        userMarker = L.circleMarker([user.lat, user.lng], {
          radius: 8,
          color: "#22C55E",
          weight: 3,
          fillColor: "#22C55E",
          fillOpacity: 0.35
        }).addTo(map).bindPopup("You are here");

        map.setView([user.lat, user.lng], 12);

        setStatus("GPS updated. Now click 'Sort Unvisited by Driving Distance'.", "ok");
        btnGPS.disabled = false;
        render();
      },
      err=>{
        console.error(err);
        setStatus("GPS error: " + err.message, "err");
        btnGPS.disabled = false;
      },
      { enableHighAccuracy:true, maximumAge: 15000, timeout: 15000 }
    );
  }

  /**************************************************************
   *  CHIP FILTERS
   **************************************************************/
  function setChipActive(idActive){
    const all = ["chipAll","chipUnvisited","chipVisited","chipHasDistance","chipNoDistance"];
    all.forEach(id=>document.getElementById(id).classList.remove("active"));
    document.getElementById(idActive).classList.add("active");
  }

  document.getElementById("chipAll").onclick = ()=>{
    filterMode="all"; filterDist="any"; unvisitedOnlyQuick=false;
    setChipActive("chipAll");
    render();
  };
  document.getElementById("chipUnvisited").onclick = ()=>{
    filterMode="unvisited"; filterDist="any"; unvisitedOnlyQuick=false;
    setChipActive("chipUnvisited");
    render();
  };
  document.getElementById("chipVisited").onclick = ()=>{
    filterMode="visited"; filterDist="any"; unvisitedOnlyQuick=false;
    setChipActive("chipVisited");
    render();
  };
  document.getElementById("chipHasDistance").onclick = ()=>{
    filterMode="all"; filterDist="has"; unvisitedOnlyQuick=false;
    setChipActive("chipHasDistance");
    render();
  };
  document.getElementById("chipNoDistance").onclick = ()=>{
    filterMode="all"; filterDist="no"; unvisitedOnlyQuick=false;
    setChipActive("chipNoDistance");
    render();
  };

  /**************************************************************
   *  TOP BUTTONS
   **************************************************************/
  btnGPS.onclick = updateGPS;
  btnSortDrive.onclick = sortUnvisitedByDrivingDistance;

  btnShowAll.onclick = ()=>{
    filterMode="all"; filterDist="any"; unvisitedOnlyQuick=false;
    setChipActive("chipAll");
    setStatus("Showing all plants.", "ok");
    render();
  };

  btnShowUnvisited.onclick = ()=>{
    filterMode="unvisited"; filterDist="any"; unvisitedOnlyQuick=true;
    setChipActive("chipUnvisited");
    setStatus("Showing unvisited only.", "ok");
    render();
  };

  btnReset.onclick = ()=>{
    if (!confirm("Reset all visited marks?")) return;
    visited = {};
    saveVisited();
    setStatus("Visited reset.", "ok");
    render();
  };

  btnRoute.onclick = drawRoute;
  btnOpenOSM.onclick = openOSM;
  btnOpenGoogle.onclick = openGoogle;
  btnWaze.onclick = openWaze;

  elQ.oninput = ()=> render();

  /**************************************************************
   *  STARTUP
   **************************************************************/
  updateProgress();
  updateGpsPill();
  elTotal.textContent = plants.length;

  // If GPS exists, show it on map
  if (user){
    userMarker = L.circleMarker([user.lat, user.lng], {
      radius: 8,
      color: "#22C55E",
      weight: 3,
      fillColor: "#22C55E",
      fillOpacity: 0.35
    }).addTo(map).bindPopup("You are here");
    map.setView([user.lat, user.lng], 12);
    setStatus("GPS loaded. You can sort by driving distance now.", "ok");
  } else {
    setStatus("Click 'Update GPS' to start.", "warn");
  }

  render();
</script>
</body>
</html>
