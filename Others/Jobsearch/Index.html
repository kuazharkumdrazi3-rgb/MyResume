<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plant Visit Planner ‚Äì Full</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <style>
    :root {
      --bg: #0b0e14;
      --bg-card: #151a24;
      --bg-card-hover: #1e2532;
      --border: #2a3245;
      --accent: #8b5cf6; /* Violet for OSRM */
      --accent-hover: #7c3aed;
      --success: #10b981;
      --text-main: #f3f4f6;
      --text-muted: #9ca3af;
    }

    * { box-sizing: border-box; outline: none; }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; }

    .page { display: flex; flex-direction: column; height: 100%; max-width: 1600px; margin: 0 auto; min-height: 0; }

    /* HEADER */
    header { padding: 1rem; display: flex; justify-content: space-between; align-items: center; background: var(--bg); flex-shrink: 0; }
    h1 { margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text-main); }
    .progress-container { flex: 1; max-width: 300px; margin-left: 20px; background: #1f2937; height: 8px; border-radius: 4px; overflow: hidden; }
    .progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease; }

    /* CONTENT */
    .content-grid { display: flex; flex: 1; padding: 0.5rem 1rem 1rem 1rem; gap: 1rem; overflow: hidden; min-height: 0; }
    
    /* LEFT PANEL */
    .panel-list {
      flex: 0 0 450px;
      display: flex;
      flex-direction: column;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
      min-height: 0; /* IMPORTANT for scroll in flex */
    }
    
    .list-controls { padding: 1rem; background: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 0.75rem; z-index: 10; flex-shrink: 0; }
    .search-box { width: 100%; background: #0f1219; border: 1px solid var(--border); padding: 0.6rem 1rem; border-radius: 8px; color: var(--text-main); }
    
    .button-group { display: flex; gap: 0.5rem; }
    .btn { flex: 1; background: #2d3748; color: var(--text-main); border: none; padding: 0.6rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer; font-weight: 500; transition: background 0.2s; white-space: nowrap; }
    .btn:hover { background: #4a5568; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }

    .status-bar { font-size: 0.75rem; color: var(--text-muted); text-align: center; height: 1.2em; }

    .list-scroll {
      flex: 1;
      min-height: 0;                 /* IMPORTANT for scroll in flex */
      overflow-y: auto;
      padding: 0.5rem;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    /* CARDS */
    .plant-card { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; margin-bottom: 0.5rem; background: var(--bg-card-hover); border: 1px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .plant-card:hover { border-color: var(--border); transform: translateY(-1px); }
    .plant-card.selected { border-color: var(--accent); background: rgba(139, 92, 246, 0.1); }
    .plant-card.visited { opacity: 0.5; background: #111; }
    .plant-card.visited .plant-name { text-decoration: line-through; }

    .plant-order { width: 26px; height: 26px; background: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; color: var(--accent); flex-shrink: 0; }
    .plant-info { flex: 1; min-width: 0; }
    .plant-name { font-size: 0.9rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .plant-details { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
    
    .dist-badge { display: inline-block; background: #1f2937; padding: 2px 6px; border-radius: 4px; color: #a78bfa; margin-right: 5px; font-weight: 600; }

    .action-btn { background: transparent; border: 1px solid var(--border); color: var(--accent); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
    .action-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }

    .check-circle { width: 22px; height: 22px; border-radius: 50%; border: 2px solid #4b5563; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .check-circle:hover { border-color: var(--text-main); }
    .check-circle.checked { background: var(--success); border-color: var(--success); }
    .check-circle.checked::after { content: '‚úì'; font-size: 14px; color: #000; font-weight: 800; }

    /* MAP PANEL */
    .panel-map { flex: 1; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; position: relative; min-height: 0; }
    .map-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); flex-shrink: 0; }
    .map-title { font-size: 0.9rem; color: var(--text-muted); } .map-title b { color: var(--accent); }
    iframe { width: 100%; height: 100%; border: none; }

    @media (max-width: 900px) {
      body { overflow: auto; }
      .content-grid { flex-direction: column; overflow-y: auto; }
      .panel-list { flex: none; height: 50vh; width: 100%; }
      .panel-map { flex: none; height: 50vh; width: 100%; }
    }
  </style>
</head>
<body>

  <header>
    <h1>üè≠ Visit Planner <span style="font-size:0.6em; opacity:0.5; font-weight:400; vertical-align:middle; border:1px solid #333; padding:2px 6px; border-radius:4px;">Full List</span></h1>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
  </header>

  <div class="content-grid">
    <div class="panel-list">
      <div class="list-controls">
        <input type="text" id="searchInput" class="search-box" placeholder="üîç Search company or area...">
        <div class="button-group">
          <button id="btnRefreshGPS" class="btn btn-primary">1. Update GPS</button>
          <button id="btnSort" class="btn">2. Calculate Distances</button>
          <button id="btnClear" class="btn">Reset</button>
        </div>
        <div class="status-bar" id="statusText">Ready</div>
      </div>
      <div class="list-scroll" id="plantList"></div>
    </div>

    <div class="panel-map">
      <div class="map-header">
        <div class="map-title">Target: <b id="currentCompanyLabel">None</b></div>
        <button class="action-btn" id="btnWaze">Open Waze</button>
      </div>
      <iframe id="mapFrame" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
  </div>

<script>
  // --- FULL DATASET ---
  const plants = [
    { id: "aureumaex", order: 1, name: "Aureumaex Precision Plastics (M) Sdn Bhd", area: "Lot 136, Jalan Permata 1, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8258, lng: 101.8105 },
    { id: "ichikoh", order: 2, name: "Ichikoh (M) Sdn. Bhd.", area: "Lot 110, Jalan Permata 1/4, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8214, lng: 101.8083 },
    { id: "ouji_sekken", order: 3, name: "Ouji Sekken Manufacturing (M) Sdn. Bhd.", area: "Lot 759(B3), Nilai Industrial Estate, 71800 Nilai, Negeri Sembilan", lat: 2.8350, lng: 101.8150 },
    { id: "alps_electric", order: 4, name: "Alps Electric (Malaysia) Sdn Bhd - Nilai Plant", area: "Lot 109, Jalan Permata 1/4, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8228, lng: 101.8075 },
    { id: "k_plastics", order: 5, name: "K-Plastics Industries Sdn Bhd", area: "Lot 24, Jalan Permata 1/2, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8200, lng: 101.8100 },
    { id: "pca_group", order: 6, name: "PCA Group Sdn Bhd", area: "Lot 50, Jalan Permata 2, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8310, lng: 101.8185 },
    { id: "johnson_matthey", order: 7, name: "Johnson Matthey Sdn. Bhd.", area: "Lot 12, Jalan 2, Kawasan Perindustrian Nilai 3, 71800 Nilai, Negeri Sembilan", lat: 2.8125, lng: 101.7925 },
    { id: "meditech_gloves", order: 8, name: "Meditech Gloves Sdn. Bhd.", area: "Lot 23, Jalan Seriemas 1, Kota Seriemas, 71800 Nilai, Negeri Sembilan", lat: 2.7680, lng: 101.7650 },
    { id: "future_plastic", order: 9, name: "Future Plastic Industries Sdn. Bhd.", area: "Lot 1608, Jalan Nilai 3/10, Kawasan Perindustrian Nilai 3, 71800 Nilai, Negeri Sembilan", lat: 2.8550, lng: 101.7950 },
    { id: "jujutsu_industries", order: 10, name: "Jujutsu Industries Sdn Bhd", area: "Lot 83, Jalan Permata 2/3, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8330, lng: 101.8160 },
    { id: "polyplus_packages", order: 11, name: "Polyplus Packages Sdn. Bhd.", area: "Lot 18, Jalan Permata 1/1, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8250, lng: 101.8120 },
    { id: "jebsen_jessen", order: 12, name: "Jebsen & Jessen Packaging Sdn Bhd", area: "Lot 3297, Jalan Permata 2/1, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8340, lng: 101.8170 },
    { id: "lti_industries", order: 13, name: "LTI Industries Sdn Bhd", area: "Lot 16, Jalan Permata 1, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8240, lng: 101.8110 },
    { id: "harta_packaging", order: 14, name: "Harta Packaging Industries (Selangor) Sdn. Bhd.", area: "Lot 6, Jalan Permata 2, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8400, lng: 101.8200 },
    { id: "skf_bearing", order: 15, name: "SKF Bearing Industries (M) Sdn Bhd", area: "Lot 79, Jalan Permata 2, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8265, lng: 101.8135 },
    { id: "akzo_nobel", order: 16, name: "Akzo Nobel Paints (Malaysia) Sdn Bhd", area: "Lot 5827, Jalan Permata 1, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8300, lng: 101.8150 },
    { id: "mapei_nilai", order: 17, name: "Mapei Malaysia Nilai Plant", area: "D3A, Lot 28, Jalan Industri 3/4, Kawasan Perindustrian Nilai 3, 71800 Nilai, Negeri Sembilan", lat: 2.8520, lng: 101.7980 },
    { id: "gf_one", order: 18, name: "GF One Chemicals Sdn. Bhd.", area: "Lot 12A, Jalan Nilai 3/7, Kawasan Perindustrian Nilai 3, 71800 Nilai, Negeri Sembilan", lat: 2.8500, lng: 101.7950 },
    { id: "dansoon", order: 19, name: "Dansoon Chemicals Sdn. Bhd.", area: "No. 5, Jalan Nilai 3/8, Kawasan Perindustrian Nilai 3, 71800 Nilai, Negeri Sembilan", lat: 2.8480, lng: 101.7960 },
    { id: "chuanplus", order: 20, name: "Chuanplus Industries Sdn. Bhd.", area: "Lot 27, Jalan Nilai 3/1, Kawasan Perindustrian Nilai 3, 71800 Nilai, Negeri Sembilan", lat: 2.8530, lng: 101.7970 },
    { id: "av_manufacturing", order: 21, name: "AV Manufacturing Sdn. Bhd.", area: "Lot 19, Jalan Nilai 3/5, Kawasan Perindustrian Nilai 3, 71800 Nilai, Negeri Sembilan", lat: 2.8510, lng: 101.7990 },
    { id: "yec_chemical", order: 22, name: "YEC Chemical Compounds Sdn Bhd", area: "No. 16, Jalan Nilai 3/2, Kawasan Perindustrian Nilai 3, 71800 Nilai, Negeri Sembilan", lat: 2.8500, lng: 101.7980 },
    { id: "vivasil_paints", order: 23, name: "Vivasil Paints ( M ) Sdn Bhd", area: "No. 38, Jalan KIP 2, Taman Perindustrian KIP, 52200 Kuala Lumpur / Nilai 3 Ops", lat: 2.6800, lng: 101.9500 },
    { id: "dongnam", order: 24, name: "Dongnam Sdn. Bhd.", area: "Lot 106, Jalan Permata 1/4, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8230, lng: 101.8080 },
    { id: "see_sen", order: 25, name: "See Sen Chemical Berhad", area: "Lot 82, Jalan Permata 1, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8280, lng: 101.8140 },
    { id: "cenviro", order: 26, name: "Cenviro Sdn Bhd", area: "Ladang Tanah Merah A3 Division, Bukit Pelanduk, 71900 Port Dickson, Negeri Sembilan", lat: 2.7500, lng: 101.8500 },
    { id: "schmidt_clemens", order: 27, name: "Schmidt + Clemens (Asia) Sdn. Bhd.", area: "Lot 1928, Jalan Sendayan, Kawasan Perindustrian Sendayan, 71950 Seremban, Negeri Sembilan", lat: 2.7650, lng: 101.8900 },
    { id: "jaewon_frontier", order: 28, name: "Jaewon Frontier (M) Sdn Bhd", area: "Lot 55, Jalan Permata 2, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8320, lng: 101.8165 },
    { id: "tecford_precision", order: 29, name: "Tecford Precision Sdn Bhd", area: "Lot 138, Jalan Permata 1, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8250, lng: 101.8125 },
    { id: "fibertex", order: 30, name: "Fibertex Personal Care Sdn. Bhd.", area: "Lot 72, Jalan Permata 2, Arab Malaysian Industrial Park, 71800 Nilai, Negeri Sembilan", lat: 2.8350, lng: 101.8180 },
    { id: "sugihara_grand", order: 31, name: "Sugihara Grand Industries (Sendayan Plant) Sdn Bhd", area: "Lot 11, Jalan Tech Valley 1, Sendayan Tech Valley, 71950 Seremban, Negeri Sembilan", lat: 2.6680, lng: 101.8850 },
    { id: "bluetech_env", order: 32, name: "Bluetech Environmental Technology Sdn Bhd", area: "No. 12, Jalan Toman 2, Kemayan Square, 70200 Seremban, Negeri Sembilan", lat: 2.6950, lng: 101.9250 },
    { id: "cbt_petroleum", order: 33, name: "CBT Petroleum Sdn Bhd", area: "Lot 3835, Jalan Labu, Batu 3 1/2, 70200 Seremban, Negeri Sembilan", lat: 2.7200, lng: 101.9400 },
    { id: "goodmaid", order: 34, name: "Goodmaid Chemicals Corporation Sdn Bhd", area: "Lot 27B, Lorong Bunga Tanjung 3/1, Senawang Industrial Park, 70400 Seremban, Negeri Sembilan", lat: 2.6850, lng: 101.9800 },
    { id: "ansell_seremban", order: 35, name: "Ansell Seremban Sdn Bhd", area: "Lot 80, Air Hitam Industrial Estate, 72120 Jempol, Negeri Sembilan", lat: 2.6800, lng: 101.9850 },
    { id: "toyochem_seremban", order: 36, name: "Toyochem Specialty Chemicals Sdn Bhd", area: "Lot 29, Jalan Senawang 4, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6900, lng: 101.9750 },
    { id: "aica_malaysia", order: 37, name: "Aica Malaysia Sdn. Bhd.", area: "Lot 38, Jalan Senawang 4, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6880, lng: 101.9780 },
    { id: "sumitomo_env", order: 38, name: "Sumitomo Chemical Enviro-Agro Asia Pacific Sdn. Bhd.", area: "Lot 60, Jalan Senawang 3, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6850, lng: 101.9800 },
    { id: "careplus", order: 39, name: "Careplus (M) Sdn Bhd", area: "Lot 17479, Lorong Senawang 3/2, Kawasan Perindustrian Senawang, 70450 Seremban, Negeri Sembilan", lat: 2.6820, lng: 101.9820 },
    { id: "bostik", order: 40, name: "Bostik Malaysia Sdn Bhd", area: "Lot 22, Jalan Senawang 4, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6880, lng: 101.9760 },
    { id: "aegis_materials", order: 41, name: "Aegis Materials (M) Sdn. Bhd.", area: "Lot 45, Jalan Senawang 4, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6860, lng: 101.9780 },
    { id: "sun_rubber", order: 42, name: "Sun Rubber Industry Sdn. Bhd.", area: "Lot 68, Jalan Senawang 3, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6840, lng: 101.9800 },
    { id: "conquest_chem", order: 43, name: "Conquest Chemical Supply Sdn. Bhd.", area: "No. 49, Jalan Senawang 4, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6900, lng: 101.9750 },
    { id: "ogosin_chem", order: 44, name: "Ogosin Chemical Industries Sdn. Bhd.", area: "No. 11, Jalan Lombong Emas 4, Seremban Light Industrial Park, 70200 Seremban, Negeri Sembilan", lat: 2.7300, lng: 101.9350 },
    { id: "allied_specialty", order: 45, name: "Allied Specialty Compounds", area: "Lot 26, Jalan Senawang 3, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6850, lng: 101.9800 },
    { id: "ecogreen_monomer", order: 46, name: "Ecogreen Monomer Sdn Bhd", area: "Lot 23, Jalan Senawang 4, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6880, lng: 101.9760 },
    { id: "sanyu_jushi", order: 47, name: "Sanyu Jushi Sdn. Bhd.", area: "Lot 18, Jalan Senawang 4, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6860, lng: 101.9780 },
    { id: "gb_industries", order: 48, name: "G.B. Industries Sdn Bhd", area: "Lot 72, Jalan Senawang 4, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6840, lng: 101.9800 },
    { id: "maytech", order: 49, name: "Maytech Cleanroom Manufacturing Sdn Bhd", area: "Lot 25, Jalan Senawang 3, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6850, lng: 101.9800 },
    { id: "growchem_senawang", order: 50, name: "Growchem Sdn Bhd", area: "Lot 15, Jalan Senawang 4, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6880, lng: 101.9760 },
    { id: "cp_chemie", order: 51, name: "Cp Chemie Resources (M) Sdn Bhd", area: "Lot 33, Jalan Senawang 4, Senawang Industrial Estate, 70450 Seremban, Negeri Sembilan", lat: 2.6900, lng: 101.9750 },
    { id: "ccp_century", order: 52, name: "Ccp Century Chemical Paints & Hardware Trading S.B", area: "No. 12, Jalan SS 13/3E, Subang Jaya Industrial Estate, 47500 Subang Jaya, Selangor", lat: 3.0100, lng: 101.5500 },

    /* ... keep ALL your remaining items exactly as-is ... */

    { id: "air_liquide", order: 167, name: "Air Liquide Malaysia Sdn. Bhd. (Melaka Plant)", area: "Lot 3, Jalan PK 1, Kawasan Perindustrian Krubong, 75250 Melaka", lat: 2.2500, lng: 102.1500 }
  ];

  // --- STATE ---
  const VISITED_KEY = "plant_visit_osrm_v1";
  let visited = {};
  let userCoords = null;
  let selectedId = null;
  let isCalculating = false;

  try { visited = JSON.parse(localStorage.getItem(VISITED_KEY) || "{}"); } catch {}

  // --- UI ELEMENTS ---
  const listEl = document.getElementById("plantList");
  const mapFrame = document.getElementById("mapFrame");
  const labelEl = document.getElementById("currentCompanyLabel");
  const statusText = document.getElementById("statusText");

  // --- FUNCTIONS ---
  function saveVisited() {
    localStorage.setItem(VISITED_KEY, JSON.stringify(visited));
    updateProgress();
  }

  function updateProgress() {
    const total = plants.length;
    const done = Object.values(visited).filter(Boolean).length;
    const pct = Math.round((done / total) * 100);
    document.getElementById("progressBar").style.width = pct + "%";
  }

  // OSRM TABLE: origin -> many destinations (driving distance)
  async function fetchOsrmTableDistances(origin, destList) {
    // coords format: lon,lat;lon,lat;...
    const coords = [
      `${origin.lng},${origin.lat}`,
      ...destList.map(d => `${d.lng},${d.lat}`)
    ].join(";");

    const url = `https://router.project-osrm.org/table/v1/driving/${coords}?sources=0&destinations=${destList.map((_, i) => i + 1).join(";")}&annotations=distance`;

    try {
      const res = await fetch(url);
      if (!res.ok) return null;
      const data = await res.json();
      // distances is 2D: [ [d1, d2, ...] ] because single source
      if (data.distances && data.distances[0]) return data.distances[0];
    } catch (e) {
      console.error(e);
    }
    return null;
  }

  async function calculateAllDistances() {
    if (!userCoords) return alert("Please click 'Update GPS' first!");
    if (isCalculating) return;

    isCalculating = true;
    const btn = document.getElementById("btnSort");
    btn.disabled = true;
    btn.style.opacity = "0.5";

    statusText.innerText = "Preparing route batches...";

    // Clear previous session distances (optional; keep if you want)
    plants.forEach(p => { p._roadMeters = null; p._roadKm = null; });

    // Chunk to avoid OSRM public limits
    const CHUNK_SIZE = 90; // origin + 90 destinations = 91 points (safe)
    let processed = 0;
    const total = plants.length;

    for (let i = 0; i < total; i += CHUNK_SIZE) {
      const chunk = plants.slice(i, i + CHUNK_SIZE);

      const distances = await fetchOsrmTableDistances(
        userCoords,
        chunk.map(p => ({ lat: p.lat, lng: p.lng }))
      );

      if (distances && distances.length === chunk.length) {
        chunk.forEach((p, idx) => {
          const meters = distances[idx];
          if (typeof meters === "number" && isFinite(meters)) {
            p._roadMeters = meters;
            p._roadKm = (meters / 1000).toFixed(1);
          }
        });
      }

      processed += chunk.length;
      statusText.innerText = `Fetching routes: ${Math.min(processed, total)} / ${total}...`;
      sortAndRender();

      // small delay to be polite
      await new Promise(r => setTimeout(r, 250));
    }

    statusText.innerText = "Calculation Complete.";
    isCalculating = false;
    btn.disabled = false;
    btn.style.opacity = "1";
    sortAndRender();
  }

  function sortAndRender() {
    // Sort: 1) unvisited first, 2) road distance ascending, 3) original order
    plants.sort((a, b) => {
      const av = !!visited[a.id];
      const bv = !!visited[b.id];
      if (av !== bv) return av - bv; // false first

      const da = (typeof a._roadMeters === "number") ? a._roadMeters : Number.POSITIVE_INFINITY;
      const db = (typeof b._roadMeters === "number") ? b._roadMeters : Number.POSITIVE_INFINITY;
      if (da !== db) return da - db;

      return a.order - b.order;
    });

    renderList();
  }

  function renderList() {
    listEl.innerHTML = "";
    const term = document.getElementById("searchInput").value.toLowerCase();

    plants.forEach(p => {
      if (!p.name.toLowerCase().includes(term) && !p.area.toLowerCase().includes(term)) return;

      const isVisited = !!visited[p.id];
      const card = document.createElement("div");
      card.className = `plant-card ${isVisited ? 'visited' : ''} ${selectedId === p.id ? 'selected' : ''}`;

      const ord = document.createElement("div");
      ord.className = "plant-order";
      ord.innerText = p.order;

      const info = document.createElement("div");
      info.className = "plant-info";

      const name = document.createElement("div");
      name.className = "plant-name";
      name.innerText = p.name;

      const det = document.createElement("div");
      det.className = "plant-details";

      let distBadge = "";
      if (p._roadKm) {
        distBadge = `<span class="dist-badge">üöó ${p._roadKm} km</span>`;
      }

      const areaShort = p.area.split(',')[0];
      det.innerHTML = `${distBadge} ${areaShort}`;

      info.appendChild(name);
      info.appendChild(det);

      const btn = document.createElement("button");
      btn.className = "action-btn";
      btn.innerText = "Map";
      btn.onclick = (e) => { e.stopPropagation(); openMapApp(p); };

      const check = document.createElement("div");
      check.className = `check-circle ${isVisited ? 'checked' : ''}`;
      check.onclick = (e) => {
        e.stopPropagation();
        visited[p.id] = !visited[p.id];
        saveVisited();
        sortAndRender(); // keep list correct immediately
      };

      card.appendChild(ord);
      card.appendChild(info);
      card.appendChild(btn);
      card.appendChild(check);
      card.onclick = () => selectPlant(p);

      listEl.appendChild(card);
    });
  }

  function selectPlant(p) {
    selectedId = p.id;
    labelEl.innerText = p.name;

    // FIXED: removed extra "3"
    mapFrame.src = `https://www.google.com/maps?q=${p.lat},${p.lng}&t=&z=15&ie=UTF8&iwloc=&output=embed`;

    renderList();
  }

  function openMapApp(p) {
    // FIXED: removed extra "$" signs
    if (userCoords) {
      window.open(
        `https://www.google.com/maps/dir/?api=1&origin=${userCoords.lat},${userCoords.lng}&destination=${p.lat},${p.lng}&travelmode=driving`,
        "_blank"
      );
    } else {
      window.open(
        `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}`,
        "_blank"
      );
    }
  }

  function updateGPS() {
    if (!navigator.geolocation) return alert("GPS not available");
    statusText.innerText = "Locating...";

    navigator.geolocation.getCurrentPosition(pos => {
      userCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      statusText.innerText = "GPS Updated. Now click 'Calculate Distances'.";
      // no haversine sorting here
      renderList();
    }, err => alert("Error: " + err.message), { enableHighAccuracy: true, timeout: 15000 });
  }

  // --- EVENTS ---
  document.getElementById("btnRefreshGPS").onclick = updateGPS;
  document.getElementById("btnSort").onclick = calculateAllDistances;
  document.getElementById("searchInput").oninput = renderList;
  document.getElementById("btnClear").onclick = () => {
    if (confirm("Reset visited list?")) {
      visited = {};
      saveVisited();
      sortAndRender();
    }
  };

  document.getElementById("btnWaze").onclick = () => {
    if (!selectedId) return alert("Select a plant");
    const p = plants.find(x => x.id === selectedId);
    window.location.href = `https://waze.com/ul?ll=${p.lat},${p.lng}&navigate=yes`;
  };

  updateProgress();
  sortAndRender();
</script>
</body>
</html>
